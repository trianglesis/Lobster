{% extends "main/main.html" %}
{% block page_title %}
    {% if not SUBJECT %}
        Inspect Celery
    {% else %}
        {{ SUBJECT }}
    {% endif %}
{% endblock %}
{% load static %}
{% load i18n %}
{% load tz %}
{% load humanize %}
{% load template_simplify %}
{% load intro_selections %}
{% block content %}
    {# STYLES #}
    <link rel="stylesheet" type="text/css" href="{% static 'octopus/css/elements/navbar-secondary.css' %}"/>
    <link rel="stylesheet" type="text/css" href="{% static 'octopus/css/celery-inspect.css' %}"/>
    <!-- Toast draw here -->
    <div aria-live="polite" aria-atomic="true" style="position: relative">
        <!-- Position it -->
        <div style="position: absolute; top: 0; left: 0;">
            <div id="toastStack" style="position: absolute;z-index: 2"></div>
        </div>
    </div>
    <!-- Workbench navbar -->
    <nav class="navbar navbar-light test-report-navbar">
    {% spaceless %}
        <!-- Navbar content -->
        <!-- Navbar left part content -->
        <div class="nav-reports-left">
            <!-- Digest levels breadcrumbs: -->
            <div class="digest-breadcrumbs">
                <nav class="nav nav-pills">
                    <div class="btn-group btn-group-sm" role="group">
                        <a class="btn btn-sm btn-info" href="{% url 'admin_workbench' %}"><i class="fas fa-step-backward"></i> Admin Workbench</a>
                        <a class="btn btn-sm btn-info" href="{% url 'celery_workbench' %}"><i class="fas fa-step-backward"></i> Celery Workbench</a>
                        <a class="btn btn-sm btn-info active" href="{% url 'celery_inspect' %}" title="You are here..."><i class="fas fa-play"></i> Celery Inspect</a>
                    </div>
                </nav>
            </div>
            <!-- Change branch here: -->
            <div class="digest-branch"></div>
            <div class="selection-state"></div>
        </div>
        <!-- Navbar right part content -->
        <div class="nav-reports-right digest-test-log-levels">
            <a id="revoke-active-tasks" class="btn btn-sm btn-warning">Revoke active</a>
            <a id="revoke-reserved-tasks" class="btn btn-sm btn-warning">Revoke reserved</a>
            <a id="revoke-all-tasks" class="btn btn-sm btn-warning">Revoke all</a>
            <a id="discard-all-tasks" class="btn btn-sm btn-danger">Tasks discard</a>
            <a id="purge-all-tasks" class="btn btn-sm btn-danger">Tasks purge</a>
        </div>
    {% endspaceless %}
    </nav>
    {# CONTENT #}
    <div class="celery-content">
        {% comment %}
        If worker - show tabs for one worker and use data-worker as selectable for JS
        If not worker - show everything in the same tabs, JS check when data-worker is undefined and also query for all.
        {% endcomment %}
        <div class="celery-workers-tabs">
            <nav>
              <div class="nav nav-pills" id="nav-tab" role="tablist">
                <a class="nav-item btn btn-sm btn-outline-success active" id="nav-active-tab" data-workers="{{ worker }}" data-operation_key="tasks_get_active"
                   data-toggle="tab" href="#nav-active" role="tab"
                   aria-controls="nav-active" aria-selected="true">Active tasks</a>
                <a class="nav-item btn btn-sm btn-outline-secondary" id="nav-reserved-tab" data-workers="{{ worker }}" data-operation_key="tasks_get_reserved"
                   data-toggle="tab" href="#nav-reserved" role="tab"
                   aria-controls="nav-reserved" aria-selected="false">Reserved Tasks</a>
                <a class="nav-item btn btn-sm btn-outline-warning" id="nav-active-reserved-tab" data-workers="{{ worker }}" data-operation_key="tasks_get_active_reserved"
                   data-toggle="tab" href="#nav-active-reserved" role="tab"
                   aria-controls="nav-active-reserved" aria-selected="false">Active & reserved</a>
                <a class="nav-item btn btn-sm btn-outline-light" id="nav-scheduled-tab" data-workers="{{ worker }}" data-operation_key="tasks_get_scheduled"
                   data-toggle="tab" href="#nav-scheduled" role="tab"
                   aria-controls="nav-scheduled" aria-selected="false">Scheduled Tasks</a>
                <a class="nav-item btn btn-sm btn-outline-light" id="nav-registered-tab" data-workers="{{ worker }}" data-operation_key="tasks_get_registered"
                   data-toggle="tab" href="#nav-registered" role="tab"
                   aria-controls="nav-registered" aria-selected="false">Registered Tasks</a>
              </div>
            </nav>
            <div class="tab-content" id="nav-tabContent">
              <div class="tab-pane fade show active" id="nav-active" role="tabpanel" aria-labelledby="nav-active-tab">
                  <div id="active">
                    <p>Active tasks for worker: {{ worker }}</p>
                  </div>
              </div>
              <div class="tab-pane fade" id="nav-reserved" role="tabpanel" aria-labelledby="nav-reserved-tab">
                  <div id="reserved">
                    <p>Reserved tasks for worker: {{ worker }}</p>
                  </div>
              </div>
              <div class="tab-pane fade" id="nav-active-reserved" role="tabpanel" aria-labelledby="nav-active-reserved-tab">
                  <div id="active-reserved">
                    <p>Active & reserved tasks for worker: {{ worker }}</p>
                  </div>
              </div>
              <div class="tab-pane fade" id="nav-scheduled" role="tabpanel" aria-labelledby="nav-scheduled-tab">
                  <div id="scheduled">
                    <p>Scheduled tasks for worker: {{ worker }}</p>
                  </div>
              </div>
              <div class="tab-pane fade" id="nav-registered" role="tabpanel" aria-labelledby="nav-registered-tab">
                  <div id="registered">
                    <p>Registered tasks for worker: {{ worker }}</p>
                  </div>
              </div>
            </div>
        </div>

        <div id="worker-card" style="display: none">
            <div class="card border-light tasks-card">
                <h6 class="card-header card-header-shrink"><span class="badge badge-info"></span></h6>
                <div class="card-body card-body-shrink">
                    <table id="task-table" class="table-bordered table-hover table-sm" style="width: 100%;">
                        <thead>
                            <tr class="text-center">
                                <td>id</td>
                                <td>name</td>
                                <td>args</td>
                                <td>type</td>
                                <td>started</td>
                                <td>actions</td>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                    <div class="worker-buttons">
                    </div>
                </div>
{#                <div class="card-footer card-footer-shrink">#}
{#                </div>#}
            </div>
        </div>
    </div>
    <!-- Navbar bottom fixed -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light fixed-bottom">
        <a class="navbar-brand" href="#"><i class="fab fa-github"></i></a>
        <ul class="navbar-nav mr-auto">
            <li class="nav-item">
                <a class="nav-link" href="{% url 'home' %}">Home</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="{% url 'admin_workbench' %}">Admin Workbench</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="{% url 'celery_workbench' %}">Celery Workbench</a>
            </li>
            <li class="nav-item active">
                <a class="nav-link" href="{% url 'celery_inspect' %}">Celery Inspect</a>
            </li>
        </ul>
        <span class="navbar-text">Octopus automation</span>
    </nav>
    {# JS #}
    <script src="{% static 'octopus/js/celery-inspect/celery-methods.js' %}"></script>
    <script src="{% static 'octopus/js/celery-inspect/celery-inspect.js' %}"></script>
    <script type="text/javascript">
        let single_worker = "{{ worker }}";
    </script>
    {% comment %}DEBUG{% endcomment %}
    <div class="debug-context">
        {% if request.GET.debug %}
            <p>DEBUG enabled</p>
            <p>actual addm_names: {{ addm_names }}</p>
            <p>Selector: {{ selector }}</p>
            <ul>
                {% for sel_k, sel_v in selector.items %}
                    {% if sel_v %}
                        <li class="text-success">{{ sel_k }} = "{{ sel_v }}"</li>
                    {% else %}
                        <li class="text-warning">{{ sel_k }} = "{{ sel_v }}"</li>
                    {% endif %}
                {% endfor %}
            </ul>
        {% endif %}
    </div>
{% endblock %}